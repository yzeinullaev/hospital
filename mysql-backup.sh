#!/bin/bash
# ะกะบัะธะฟั ะดะปั ัะตะทะตัะฒะฝะพะณะพ ะบะพะฟะธัะพะฒะฐะฝะธั ะดะฐะฝะฝัั MySQL

set -e

echo "๐๏ธ MySQL Backup Script"
echo "======================"

# ะกะพะทะดะฐะตะผ ะดะธัะตะบัะพัะธั ะดะปั ะฑัะบะฐะฟะพะฒ ะตัะปะธ ะตั ะฝะตั
BACKUP_DIR="./mysql/backups"
mkdir -p "$BACKUP_DIR"

# ะะตะฝะตัะธััะตะผ ะธะผั ัะฐะนะปะฐ ั ัะตะบััะตะน ะดะฐัะพะน
BACKUP_FILE="$BACKUP_DIR/hospital_feedback_$(date +%Y%m%d_%H%M%S).sql"

echo "๐ฆ ะกะพะทะดะฐะฝะธะต ัะตะทะตัะฒะฝะพะน ะบะพะฟะธะธ..."
echo "ะคะฐะนะป: $BACKUP_FILE"

# ะกะพะทะดะฐะตะผ ัะตะทะตัะฒะฝัั ะบะพะฟะธั
docker-compose -f docker-compose.local.yml exec -T mysql mysqldump -u root -ppassword hospital_feedback > "$BACKUP_FILE"

if [ $? -eq 0 ]; then
    echo "โ ะะตะทะตัะฒะฝะฐั ะบะพะฟะธั ัะพะทะดะฐะฝะฐ ััะฟะตัะฝะพ!"
    echo "๐ ะคะฐะนะป: $BACKUP_FILE"
    echo "๐ ะะฐะทะผะตั: $(du -h "$BACKUP_FILE" | cut -f1)"
else
    echo "โ ะัะธะฑะบะฐ ะฟัะธ ัะพะทะดะฐะฝะธะธ ัะตะทะตัะฒะฝะพะน ะบะพะฟะธะธ"
    exit 1
fi

# ะะฒัะพะผะฐัะธัะตัะบะฐั ะพัะธััะบะฐ ััะฐััั ะฑัะบะฐะฟะพะฒ
echo "๐งน ะัะธััะบะฐ ััะฐััั ัะตะทะตัะฒะฝัั ะบะพะฟะธะน..."

# ะฃะดะฐะปัะตะผ ัะฐะนะปั ััะฐััะต 7 ะดะฝะตะน (ะพััะฐะฒะปัะตะผ ะฟะพัะปะตะดะฝะธะต 10)
cd "$BACKUP_DIR"

# ะฃะดะฐะปัะตะผ ัะฐะนะปั ััะฐััะต 7 ะดะฝะตะน
find . -name "*.sql" -type f -mtime +7 -delete

# ะัะปะธ ัะฐะนะปะพะฒ ะฑะพะปััะต 10, ัะดะฐะปัะตะผ ัะฐะผัะต ััะฐััะต
BACKUP_COUNT=$(ls -t *.sql 2>/dev/null | wc -l)
if [ "$BACKUP_COUNT" -gt 10 ]; then
    echo "๐ ะะฐะนะดะตะฝะพ $BACKUP_COUNT ัะฐะนะปะพะฒ, ัะดะฐะปัะตะผ ััะฐััะต..."
    ls -t *.sql | tail -n +11 | xargs -r rm
    echo "โ ะฃะดะฐะปะตะฝะพ ััะฐััั ัะฐะนะปะพะฒ: $((BACKUP_COUNT - 10))"
else
    echo "โ ะคะฐะนะปะพะฒ ะฒ ะฟัะตะดะตะปะฐั ะฝะพัะผั: $BACKUP_COUNT"
fi

# ะะพะบะฐะทัะฒะฐะตะผ ัะตะบััะธะต ะฑัะบะฐะฟั
echo ""
echo "๐ ะขะตะบััะธะต ัะตะทะตัะฒะฝัะต ะบะพะฟะธะธ:"
ls -la *.sql 2>/dev/null | head -5 || echo "ะะตะทะตัะฒะฝัะต ะบะพะฟะธะธ ะฝะต ะฝะฐะนะดะตะฝั"

echo ""
echo "๐ ะะตะทะตัะฒะฝะพะต ะบะพะฟะธัะพะฒะฐะฝะธะต ะทะฐะฒะตััะตะฝะพ!"
echo "๐พ ะัะธััะบะฐ: ัะฐะนะปั ััะฐััะต 7 ะดะฝะตะน + ะผะฐะบัะธะผัะผ 10 ัะฐะนะปะพะฒ" 