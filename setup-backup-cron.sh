#!/bin/bash
# –°–∫—Ä–∏–ø—Ç –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ —Ä–µ–∑–µ—Ä–≤–Ω–æ–≥–æ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è

set -e

echo "‚è∞ –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ —Ä–µ–∑–µ—Ä–≤–Ω–æ–≥–æ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è"
echo "=================================================="

# –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –º—ã –≤ –∫–æ—Ä–Ω–µ –ø—Ä–æ–µ–∫—Ç–∞
if [ ! -f "docker-compose.yml" ]; then
    echo "‚ùå –ó–∞–ø—É—Å—Ç–∏—Ç–µ —Å–∫—Ä–∏–ø—Ç –∏–∑ –∫–æ—Ä–Ω—è –ø—Ä–æ–µ–∫—Ç–∞"
    exit 1
fi

# –ü–æ–ª—É—á–∞–µ–º –∞–±—Å–æ–ª—é—Ç–Ω—ã–π –ø—É—Ç—å –∫ –ø—Ä–æ–µ–∫—Ç—É
PROJECT_DIR=$(pwd)
BACKUP_SCRIPT="$PROJECT_DIR/mysql-backup.sh"

echo "üìÅ –ü—Ä–æ–µ–∫—Ç: $PROJECT_DIR"
echo "üì¶ –°–∫—Ä–∏–ø—Ç –±—ç–∫–∞–ø–∞: $BACKUP_SCRIPT"

# –î–µ–ª–∞–µ–º —Å–∫—Ä–∏–ø—Ç –∏—Å–ø–æ–ª–Ω—è–µ–º—ã–º
chmod +x "$BACKUP_SCRIPT"

# –°–æ–∑–¥–∞–µ–º cron –∑–∞–¥–∞—á—É
CRON_JOB="0 2 * * * $BACKUP_SCRIPT >> $PROJECT_DIR/mysql/backups/backup.log 2>&1"

echo ""
echo "üìã –ù–∞—Å—Ç—Ä–æ–π–∫–∞ cron –∑–∞–¥–∞—á–∏..."
echo "‚è∞ –í—Ä–µ–º—è: –∫–∞–∂–¥—ã–π –¥–µ–Ω—å –≤ 2:00 —É—Ç—Ä–∞"
echo "üìù –ó–∞–¥–∞—á–∞: $CRON_JOB"

# –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —É–∂–µ —Ç–∞–∫–∞—è –∑–∞–¥–∞—á–∞
if crontab -l 2>/dev/null | grep -q "$BACKUP_SCRIPT"; then
    echo "‚ö†Ô∏è  –ó–∞–¥–∞—á–∞ —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –≤ cron"
    echo "üìã –¢–µ–∫—É—â–∏–µ –∑–∞–¥–∞—á–∏:"
    crontab -l | grep -E "(backup|mysql)" || echo "–ù–µ—Ç –∑–∞–¥–∞—á —Ä–µ–∑–µ—Ä–≤–Ω–æ–≥–æ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è"
else
    # –î–æ–±–∞–≤–ª—è–µ–º –∑–∞–¥–∞—á—É –≤ cron
    (crontab -l 2>/dev/null; echo "$CRON_JOB") | crontab -
    echo "‚úÖ –ó–∞–¥–∞—á–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∞ –≤ cron"
fi

echo ""
echo "üìä –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!"
echo ""
echo "üîß –ü–æ–ª–µ–∑–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:"
echo "‚Ä¢ crontab -l - –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å –≤—Å–µ –∑–∞–¥–∞—á–∏"
echo "‚Ä¢ crontab -r - —É–¥–∞–ª–∏—Ç—å –≤—Å–µ –∑–∞–¥–∞—á–∏ (–æ—Å—Ç–æ—Ä–æ–∂–Ω–æ!)"
echo "‚Ä¢ tail -f $PROJECT_DIR/mysql/backups/backup.log - –ª–æ–≥–∏ –±—ç–∫–∞–ø–æ–≤"
echo "‚Ä¢ $BACKUP_SCRIPT - –∑–∞–ø—É—Å—Ç–∏—Ç—å –±—ç–∫–∞–ø –≤—Ä—É—á–Ω—É—é"
echo ""
echo "üíæ –ü–æ–ª–∏—Ç–∏–∫–∞ –æ—á–∏—Å—Ç–∫–∏:"
echo "‚Ä¢ –§–∞–π–ª—ã —Å—Ç–∞—Ä—à–µ 7 –¥–Ω–µ–π —É–¥–∞–ª—è—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏"
echo "‚Ä¢ –ú–∞–∫—Å–∏–º—É–º 10 —Ñ–∞–π–ª–æ–≤ –±—ç–∫–∞–ø–∞"
echo "‚Ä¢ –õ–æ–≥–∏ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ backup.log" 